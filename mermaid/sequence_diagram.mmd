sequenceDiagram
    participant EVSE
    participant EV

    rect rgb(240, 240, 240)
        note over EVSE, EV: 1. Physical Connection & State Detection
        EVSE->>EVSE: Initialize (Set CP Mode, Start CP Service, Start SLAC)
        EV->>EV: Initialize (Set CP Mode, Start CP Service, Set State B, Start SLAC)
        
        note over EVSE: EVSE sets 100% duty cycle (State A)
        EVSE->>EV: Control Pilot (CP) Signal (State A)
        
        note over EV: EV connects, transitions to State B
        EV->>EVSE: CP State Change (State B)
        
        EVSE->>EVSE: _waitEvConnected(): Detects State B
        note over EVSE, EV: EV is connected
    end

    rect rgb(230, 230, 250)
        note over EVSE, EV: 2. SLAC (Signal Level Attenuation Characterization)
        EVSE->>EVSE: _handleEvConnected(): slacStartMatching()
        EVSE->>EV: Set CP Duty Cycle to 5%
        
        EV->>EV: _waitEvseConnected(): Detects 5% duty cycle
        EV->>EVSE: SLAC Association Request
        EVSE->>EV: SLAC Association Response
        
        EVSE->>EVSE: slacMatched() -> Success
        EV->>EV: slacMatched() -> Success
        note over EVSE, EV: PLC Network Established
    end

    rect rgb(230, 250, 230)
        note over EVSE, EV: 3. V2G High-Level Communication (ISO 15118)
        EVSE->>EVSE: _handleNetworkEstablished(): Start V2G Listen
        EV->>EV: _handleNetworkEstablished(): Start V2G Session
        
        EV->>EVSE: SessionSetupReq
        EVSE->>EV: SessionSetupRes
        
        EVSE->>EVSE: _handleSessionStarted()
        EV->>EV: _handleSessionStarted()
        
        EV->>EVSE: ServiceDiscoveryReq
        EVSE->>EV: ServiceDiscoveryRes
        
        EV->>EVSE: PaymentServiceSelectionReq
        EVSE->>EV: PaymentServiceSelectionRes
        
        EV->>EVSE: AuthorizationReq
        EVSE->>EVSE: _handleRequestAuthorization()
        note over EVSE: User authorizes via input
        EVSE->>EV: AuthorizationRes (Authorized)
        
        EV->>EVSE: ChargeParameterDiscoveryReq
        EVSE->>EV: ChargeParameterDiscoveryRes
        
        EVSE->>EVSE: _handleEnergyTransferModeSelected()
        EV->>EV: _handleScheduleReceived()
        
        alt DC Charging
            EV->>EVSE: CableCheckReq
            EVSE->>EV: CableCheckRes
            EVSE->>EVSE: _handleRequestCableCheck()
            EV->>EV: _handleCableCheckFinished()
            
            EV->>EVSE: PreChargeReq
            EVSE->>EV: PreChargeRes
            EVSE->>EVSE: _handlePreChargeStarted()
            EV->>EV: _handlePreChargingReady()
        end

        EV->>EVSE: PowerDeliveryReq (Start Charging)
        EVSE->>EV: PowerDeliveryRes
        EVSE->>EVSE: _handleRequestStartCharging()
        EV->>EV: _handleChargingStarted()
        
        loop Charging Loop
            EV->>EVSE: CurrentDemandReq
            EVSE->>EV: CurrentDemandRes
            EVSE->>EVSE: _handleDCChargeParametersChanged()
            EV->>EV: _handleDCChargeParametersChanged()
        end
        
        EV->>EVSE: PowerDeliveryReq (Stop Charging)
        EVSE->>EV: PowerDeliveryRes
        EVSE->>EVSE: _handleRequestStopCharging()
        EV->>EV: _handleChargingStopped()
        
        EV->>EVSE: SessionStopReq
        EVSE->>EV: SessionStopRes
        EVSE->>EVSE: _handleSessionStopped()
        EV->>EV: _handleSessionStopped()
    end
